<head>
  <title>Treemap</title>
  <script src="//unpkg.com/treemap-chart"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
  />
</head>
<body>
  <main>
    <div id="treemap"></div>
  </main>
  <script>
    const main = async () => {
      const accountsResp = await fetch('./Genesis/accounts.json')
      let accounts = await accountsResp.json()

      const fmt = (n) => numeral(n).format('0.[00]a')

      accounts = Object.fromEntries(
        Object.entries(accounts).map(
          ([address, { rescaledAllocation, rawBalances, ...account }]) => [
            address,
            {
              ...account,
              rawBalances: Object.fromEntries(
                Object.entries(rawBalances).map(([key, value]) => [
                  key,
                  parseInt(value) / 1e18,
                ]),
              ),
              rescaledAllocation: Object.fromEntries(
                Object.entries(rescaledAllocation).map(([key, value]) => [
                  key,
                  parseInt(value) / 1e18,
                ]),
              ),
            },
          ],
        ),
      )

      const voteEntries = Object.entries(accounts).filter(
        ([, { vote }]) => vote === 'Y',
      )
      const vlCvxEntries = Object.entries(accounts).filter(
        ([
          ,
          {
            rescaledAllocation: { vlCVX },
          },
        ]) => vlCVX > 0,
      )
      const balEntries = Object.entries(accounts).filter(
        ([
          ,
          {
            rescaledAllocation: { BAL },
          },
        ]) => BAL > 0,
      )

      const data = {
        name: 'root',
        children: [
          {
            name: 'Vote',
            color: 'transparent',
            tooltipContent: `${voteEntries.length} accounts (${fmt(
              voteEntries.reduce(
                (
                  prev,
                  [
                    ,
                    {
                      rawBalances: { votingPower },
                    },
                  ],
                ) => prev + votingPower,
                0,
              ),
            )} voting power)`,
            children: voteEntries.map(
              ([address, { rawBalances, rescaledAllocation }], index) => ({
                name: address.slice(0, 6),
                address,
                value: rescaledAllocation.votingPower,
                color: index % 2 === 0 ? '#59a619' : '#91c765',
                tooltipContent: `${fmt(
                  rescaledAllocation.votingPower,
                )} AURA (${fmt(rawBalances.votingPower)} voting power)`,
              }),
            ),
          },
          {
            name: 'vlCVX',
            tooltipContent: `${vlCvxEntries.length} accounts (${fmt(
              vlCvxEntries.reduce(
                (
                  prev,
                  [
                    ,
                    {
                      rawBalances: { vlCVX },
                    },
                  ],
                ) => prev + vlCVX,
                0,
              ),
            )} vlCVX)`,
            color: 'transparent',
            children: vlCvxEntries.map(
              ([address, { rawBalances, rescaledAllocation }], index) => ({
                name: address.slice(0, 6),
                address,
                value: rescaledAllocation.vlCVX,
                color: index % 2 === 0 ? '#ffa200' : '#fdbe49',
                tooltipContent: `${fmt(rescaledAllocation.vlCVX)} AURA (${fmt(
                  rawBalances.vlCVX,
                )} vlCVX)`,
              }),
            ),
          },
          {
            name: 'BAL',
            color: 'transparent',
            tooltipContent: `${balEntries.length} accounts (${fmt(
              balEntries.reduce(
                (
                  prev,
                  [
                    ,
                    {
                      rawBalances: { BAL },
                    },
                  ],
                ) => prev + BAL,
                0,
              ),
            )} BAL)`,
            children: balEntries.map(
              ([address, { rawBalances, rescaledAllocation }], index) => ({
                name: address.slice(0, 6),
                address,
                value: rescaledAllocation.BAL,
                color: index % 2 === 0 ? '#053a77' : '#163f64',
                tooltipContent: `${fmt(rescaledAllocation.BAL)} AURA (${fmt(
                  rawBalances.BAL,
                )} BAL)`,
              }),
            ),
          },
        ],
      }

      const chart = Treemap()
        .data(data)
        .excludeRoot(true)
        .tooltipContent((node) => {
          return node.tooltipContent || ''
        })
        .padding(0)
        .color('color')
        .onClick((node) => {
          if (node.address) {
            window.open(`https://etherscan.io/address/${node.address}`)
          }
        })

      chart(document.getElementById('treemap'))
    }
    main()
  </script>
</body>
